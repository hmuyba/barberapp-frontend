<div class="agendar-container">
  <!-- Header -->
  <nav class="navbar navbar-dark bg-cliente">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-scissors me-2"></i>
        BarberApp
      </a>
      <button class="btn btn-outline-light btn-sm" (click)="goToDashboard()">
        <i class="bi bi-arrow-left me-1"></i>
        Volver
      </button>
    </div>
  </nav>

  <!-- Contenido Principal -->
  <div class="container py-4">
    <!-- Vista de Éxito -->
    <div *ngIf="success" class="success-container text-center py-5">
      <div class="success-icon mb-4">
        <i class="bi bi-check-circle-fill text-success display-1"></i>
      </div>
      <h2 class="text-success mb-3">¡Cita Confirmada!</h2>
      <p class="text-muted mb-4">Tu cita ha sido agendada exitosamente</p>

      <div class="card mx-auto" style="max-width: 400px">
        <div class="card-body">
          <p class="mb-2">
            <strong>Código de confirmación:</strong>
          </p>
          <h3 class="text-primary mb-3">#{{ createdAppointmentId }}</h3>
          <hr />
          <p class="mb-1">
            <i class="bi bi-calendar3 me-2"></i>
            {{ formatDate(selectedSlot!.dateTime) }}
          </p>
          <p class="mb-1">
            <i class="bi bi-clock me-2"></i>
            {{ selectedSlot!.timeString }} hrs
          </p>
          <p class="mb-1">
            <i class="bi bi-person me-2"></i>
            {{ selectedBarber!.fullName }}
          </p>
          <p class="mb-1">
            <i class="bi bi-scissors me-2"></i>
            {{ selectedService!.name }}
          </p>
          <p class="mb-0">
            <i class="bi bi-cash me-2"></i>
            <strong>Bs. {{ selectedService!.price }}</strong>
          </p>
        </div>
      </div>

      <div class="alert alert-info mx-auto mt-4" style="max-width: 400px">
        <i class="bi bi-envelope me-2"></i>
        Recibirás un correo de confirmación y un recordatorio 24 horas antes.
      </div>

      <button class="btn btn-primary btn-lg mt-3" (click)="goToDashboard()">
        <i class="bi bi-house me-2"></i>
        Volver al Inicio
      </button>
    </div>

    <!-- Wizard de Pasos -->
    <div *ngIf="!success">
      <!-- Progress Bar -->
      <div class="progress-container mb-4">
        <div class="d-flex justify-content-between mb-2">
          <span class="small">Paso {{ currentStep }} de {{ totalSteps }}</span>
          <span class="small text-primary">{{ getStepTitle() }}</span>
        </div>
        <div class="progress" style="height: 8px">
          <div
            class="progress-bar bg-primary"
            [style.width.%]="(currentStep / totalSteps) * 100"
          ></div>
        </div>
      </div>

      <!-- Error Alert -->
      <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ error }}
        <button type="button" class="btn-close" (click)="error = null"></button>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted">Cargando...</p>
      </div>

      <!-- PASO 1: Seleccionar Barbero -->
      <div *ngIf="currentStep === 1 && !loading">
        <h4 class="mb-4">
          <i class="bi bi-person-badge me-2 text-primary"></i>
          ¿Con qué barbero quieres tu cita?
        </h4>

        <div class="row g-3">
          <div *ngFor="let barber of barbers" class="col-md-6">
            <div
              class="card barber-card"
              [class.selected]="selectedBarber?.id === barber.id"
              (click)="selectBarber(barber)"
            >
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div
                    class="avatar me-3"
                    [class.bg-primary]="selectedBarber?.id === barber.id"
                    [class.bg-secondary]="selectedBarber?.id !== barber.id"
                  >
                    {{ barber.fullName.charAt(0) }}
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="mb-1">{{ barber.fullName }}</h5>
                    <div class="text-warning mb-1">
                      <i
                        *ngFor="let star of [1, 2, 3, 4, 5]"
                        class="bi"
                        [class.bi-star-fill]="star <= (barber.rating || 0)"
                        [class.bi-star]="star > (barber.rating || 0)"
                      ></i>
                      <small class="text-muted ms-1"
                        >({{ barber.rating || "N/A" }})</small
                      >
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-briefcase me-1"></i>
                      {{ barber.yearsOfExperience }} años de experiencia
                    </small>
                    <br />
                    <small *ngIf="barber.specialty" class="text-muted">
                      <i class="bi bi-award me-1"></i>
                      {{ barber.specialty }}
                    </small>
                  </div>
                  <div *ngIf="selectedBarber?.id === barber.id">
                    <i class="bi bi-check-circle-fill text-primary fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          *ngIf="barbers.length === 0 && !loading"
          class="alert alert-info text-center"
        >
          <i class="bi bi-info-circle me-2"></i>
          No hay barberos disponibles en este momento.
        </div>
      </div>

      <!-- PASO 2: Seleccionar Fecha y Hora -->
      <div *ngIf="currentStep === 2 && !loading">
        <h4 class="mb-4">
          <i class="bi bi-calendar3 me-2 text-primary"></i>
          ¿Cuándo quieres tu cita?
        </h4>

        <!-- Barbero seleccionado -->
        <div class="alert alert-light mb-4">
          <i class="bi bi-person-badge me-2"></i>
          <strong>Barbero seleccionado:</strong> {{ selectedBarber?.fullName }}
          <span class="text-warning ms-2">
            <i class="bi bi-star-fill"></i>
            {{ selectedBarber?.rating || "N/A" }}
          </span>
        </div>

        <!-- Selector de fecha -->
        <div class="mb-4">
          <label class="form-label fw-bold">Selecciona la fecha:</label>
          <input
            type="date"
            class="form-control form-control-lg"
            [(ngModel)]="selectedDate"
            [min]="minDate"
            (change)="onDateChange()"
          />
        </div>

        <!-- Horarios disponibles -->
        <div *ngIf="selectedDate">
          <label class="form-label fw-bold">Horarios disponibles:</label>

          <div *ngIf="loadingSlots" class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary"></div>
            <span class="ms-2">Cargando horarios...</span>
          </div>

          <div *ngIf="!loadingSlots" class="slots-grid">
            <button
              *ngFor="let slot of availableSlots"
              class="btn slot-btn"
              [class.btn-outline-primary]="
                slot.isAvailable && selectedSlot?.dateTime !== slot.dateTime
              "
              [class.btn-primary]="selectedSlot?.dateTime === slot.dateTime"
              [class.btn-outline-secondary]="!slot.isAvailable"
              [disabled]="!slot.isAvailable"
              (click)="selectSlot(slot)"
            >
              {{ slot.timeString }}
              <i
                *ngIf="selectedSlot?.dateTime === slot.dateTime"
                class="bi bi-check ms-1"
              ></i>
            </button>
          </div>

          <div
            *ngIf="!loadingSlots && availableSlots.length === 0"
            class="alert alert-warning mt-3"
          >
            <i class="bi bi-exclamation-triangle me-2"></i>
            No hay horarios disponibles para esta fecha.
          </div>

          <p class="text-muted small mt-3">
            <i class="bi bi-info-circle me-1"></i>
            Los horarios en gris ya están ocupados.
          </p>
        </div>
      </div>

      <!-- PASO 3: Seleccionar Servicio -->
      <div *ngIf="currentStep === 3 && !loading">
        <h4 class="mb-4">
          <i class="bi bi-scissors me-2 text-primary"></i>
          ¿Qué servicio necesitas?
        </h4>

        <!-- Resumen parcial -->
        <div class="alert alert-light mb-4">
          <div class="row">
            <div class="col-auto">
              <i class="bi bi-person-badge me-1"></i>
              <strong>{{ selectedBarber?.fullName }}</strong>
            </div>
            <div class="col-auto">
              <i class="bi bi-calendar3 me-1"></i>
              {{ formatDate(selectedSlot!.dateTime) }}
            </div>
            <div class="col-auto">
              <i class="bi bi-clock me-1"></i>
              {{ selectedSlot?.timeString }} hrs
            </div>
          </div>
        </div>

        <!-- Lista de servicios -->
        <div class="row g-3">
          <div *ngFor="let service of services" class="col-12">
            <div
              class="card service-card"
              [class.selected]="selectedService?.id === service.id"
              (click)="selectService(service)"
            >
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">{{ service.name }}</h5>
                    <p
                      *ngIf="service.description"
                      class="text-muted mb-1 small"
                    >
                      {{ service.description }}
                    </p>
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>
                      Duración: {{ service.durationMinutes }} minutos
                    </small>
                  </div>
                  <div class="text-end">
                    <h4 class="text-primary mb-0">Bs. {{ service.price }}</h4>
                    <i
                      *ngIf="selectedService?.id === service.id"
                      class="bi bi-check-circle-fill text-primary fs-4"
                    ></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notas adicionales -->
        <div class="mt-4">
          <label class="form-label fw-bold"
            >Notas adicionales (opcional):</label
          >
          <textarea
            class="form-control"
            rows="2"
            [(ngModel)]="notes"
            placeholder="Ej: Prefiero corte con máquina #2..."
          ></textarea>
        </div>

        <!-- Resumen final -->
        <div *ngIf="selectedService" class="card mt-4 bg-light">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-receipt me-2"></i>Resumen de tu cita
            </h5>
            <hr />
            <p class="mb-1">
              <i class="bi bi-person me-2"></i>
              <strong>Barbero:</strong> {{ selectedBarber?.fullName }}
            </p>
            <p class="mb-1">
              <i class="bi bi-calendar3 me-2"></i>
              <strong>Fecha:</strong> {{ formatDate(selectedSlot!.dateTime) }}
            </p>
            <p class="mb-1">
              <i class="bi bi-clock me-2"></i>
              <strong>Hora:</strong> {{ selectedSlot?.timeString }} hrs
            </p>
            <p class="mb-1">
              <i class="bi bi-scissors me-2"></i>
              <strong>Servicio:</strong> {{ selectedService.name }} ({{
                selectedService.durationMinutes
              }}
              min)
            </p>
            <hr />
            <p class="mb-0 fs-5">
              <i class="bi bi-cash me-2"></i>
              <strong>Total: Bs. {{ selectedService.price }}</strong>
            </p>
          </div>
        </div>
      </div>

      <!-- Botones de navegación -->
      <div class="navigation-buttons mt-4 pt-3 border-top">
        <div class="row g-2">
          <div class="col-6">
            <button
              *ngIf="currentStep > 1"
              class="btn btn-outline-secondary w-100"
              (click)="prevStep()"
            >
              <i class="bi bi-arrow-left me-1"></i>
              Atrás
            </button>
            <button
              *ngIf="currentStep === 1"
              class="btn btn-outline-secondary w-100"
              (click)="goToDashboard()"
            >
              <i class="bi bi-x me-1"></i>
              Cancelar
            </button>
          </div>
          <div class="col-6">
            <button
              *ngIf="currentStep < totalSteps"
              class="btn btn-primary w-100"
              [disabled]="!canProceed()"
              (click)="nextStep()"
            >
              Continuar
              <i class="bi bi-arrow-right ms-1"></i>
            </button>
            <button
              *ngIf="currentStep === totalSteps"
              class="btn btn-success w-100"
              [disabled]="!canProceed() || loading"
              (click)="confirmAppointment()"
            >
              <span
                *ngIf="loading"
                class="spinner-border spinner-border-sm me-1"
              ></span>
              <i *ngIf="!loading" class="bi bi-check-lg me-1"></i>
              Confirmar Cita
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
